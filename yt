#!/bin/bash

# Get random color
RAND_COLOR=$(printf "#%06x" $((RANDOM * RANDOM % 0xFFFFFF)))

# Get input video resolution
eval $(ffprobe -v error -select_streams v:0 -show_entries stream=width,height -of default=noprint_wrappers=1 input.mp4)

# Add 20px to width and height
NEW_WIDTH=$((width + 20))
NEW_HEIGHT=$((height + 20))

# Run ffmpeg with corrected filters
ffmpeg -y -i input.mp4 -ss 4 -i input.mp4 -filter_complex \
"color=c=${RAND_COLOR}:size=${NEW_WIDTH}x${NEW_HEIGHT}:d=999[bg]; \
 color=c=${RAND_COLOR}:size=${NEW_WIDTH}x${NEW_HEIGHT}:d=0.1[flash]; \
 [0:v]scale=iw:ih[v2_raw]; \
 [1:v]crop=in_w/2:in_h/2:(in_w-out_w)/2+((in_w-out_w)/2)*sin(t*0.5):(in_h-out_h)/2+((in_h-out_h)/2)*sin(t*0.2),boxblur=1:1,scale=iw*2:ih*2[v1_raw]; \
 [v2_raw]format=rgba,lutyuv='u=128:v=128',scale=iw:ih[v2]; \
 [v1_raw]format=rgba,lutyuv='u=128:v=128',scale=iw:ih[v1]; \
 [bg][v2]overlay=10:10:format=auto[base]; \
 [base][v1]overlay=10:10:enable='gte(mod(t\,5)\,3)':format=auto[main]; \
 [main]lutrgb='r=negval:g=negval:b=negval':enable='between(mod(t\,30)\,0\,0.1)'[inv]; \
 [inv][flash]overlay=enable='between(mod(t\,58)\,0\,0.1)':format=auto[outv]; \
 [0:a]atempo=1.0,bass=g=3:f=110:w=20,bass=g=10:f=500:w=20,bass=g=3:f=300:w=30,bass=g=10:f=110:w=20,bass=g=20:f=110:w=40,firequalizer=gain_entry='entry(0\,-23);entry(250\,-11.5);entry(6000\,0);entry(12000\,8);entry(16000\,16)',compand=attacks=7:decays=1:points=-90/-90 -70/-60 -15/-15 0/-10:soft-knee=1:volume=-70:gain=3,pan=stereo|FL<FL+0.5*FC+0.6*BL+0.6*SL|FR<FR+2*FC+1*BR+2*SR,highpass=f=300,lowpass=f=700,volume=6[a1]; \
 amovie=bg2.mp4:loop=9999,volume=1[a2]; \
 [a1][a2]amix=duration=shortest" \
-map "[outv]" -map "[a1]" -vcodec libx264 -pix_fmt yuv420p -r 30 -g 60 -b:v 1550k -shortest \
-acodec aac -b:a 128k -ar 44100 \
-metadata title="" -metadata artist="" -metadata album_artist="" -metadata album="" \
-metadata date="" -metadata track="" -metadata genre="" -metadata publisher="" \
-metadata encoded_by="" -metadata copyright="" -metadata composer="" \
-metadata performer="" -metadata TIT1="" -metadata TIT3="" -metadata disc="" \
-metadata TKEY="" -metadata TBPM="" -metadata language="eng" -metadata encoder="" \
-threads 0 -preset ultrafast -crf 30 output.mp4
